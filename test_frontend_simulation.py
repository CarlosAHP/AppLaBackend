#!/usr/bin/env python3
"""
Script de prueba para simular el comportamiento del frontend
"""

import os
import sys
import json
import requests
from datetime import datetime

# Agregar el directorio ra√≠z al path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.services.frontend_html_service import FrontendHTMLService
from app.config import Config

def simulate_frontend_workflow():
    """Simular el flujo de trabajo completo del frontend"""
    
    print("üåê Simulando comportamiento del frontend...")
    print("=" * 60)
    
    try:
        # Crear instancia del servicio
        config = Config()
        service = FrontendHTMLService(config)
        
        print(f"‚úÖ Servicio creado exitosamente")
        
        # 1. SIMULAR SUBIDA DE ARCHIVOS DESDE EL FRONTEND
        print("\nüì§ 1. SIMULANDO SUBIDA DE ARCHIVOS DESDE EL FRONTEND")
        print("-" * 50)
        
        # Crear varios archivos HTML de prueba
        test_files = [
            {
                "html_content": """
                <html>
                <head><title>Hemograma Completo</title></head>
                <body>
                    <h1>Laboratorio Esperanza</h1>
                    <h2>Hemograma Completo</h2>
                    <div>
                        <p><strong>Paciente:</strong> Carlos Alfonso Hern√°ndez P√©rez</p>
                        <p><strong>Orden:</strong> 005</p>
                        <p><strong>Doctor:</strong> Dr. Garc√≠a</p>
                        <p><strong>Fecha:</strong> {}</p>
                    </div>
                    <div>
                        <h3>Resultados:</h3>
                        <ul>
                            <li>Hemoglobina: 14.5 g/dL</li>
                            <li>Hematocrito: 42%</li>
                            <li>Leucocitos: 7,500/ŒºL</li>
                        </ul>
                    </div>
                </body>
                </html>
                """.format(datetime.now().strftime("%d/%m/%Y")),
                "metadata": {
                    "patient_name": "Carlos Alfonso Hern√°ndez P√©rez",
                    "order_number": "005",
                    "doctor_name": "Dr. Garc√≠a",
                    "notes": "Hemograma completo - Prueba frontend"
                }
            },
            {
                "html_content": """
                <html>
                <head><title>Qu√≠mica Sangu√≠nea</title></head>
                <body>
                    <h1>Laboratorio Esperanza</h1>
                    <h2>Qu√≠mica Sangu√≠nea</h2>
                    <div>
                        <p><strong>Paciente:</strong> Mar√≠a Gonz√°lez L√≥pez</p>
                        <p><strong>Orden:</strong> 006</p>
                        <p><strong>Doctor:</strong> Dr. Mart√≠nez</p>
                        <p><strong>Fecha:</strong> {}</p>
                    </div>
                    <div>
                        <h3>Resultados:</h3>
                        <ul>
                            <li>Glucosa: 95 mg/dL</li>
                            <li>Colesterol: 180 mg/dL</li>
                            <li>Triglic√©ridos: 120 mg/dL</li>
                        </ul>
                    </div>
                </body>
                </html>
                """.format(datetime.now().strftime("%d/%m/%Y")),
                "metadata": {
                    "patient_name": "Mar√≠a Gonz√°lez L√≥pez",
                    "order_number": "006",
                    "doctor_name": "Dr. Mart√≠nez",
                    "notes": "Qu√≠mica sangu√≠nea - Prueba frontend"
                }
            },
            {
                "html_content": """
                <html>
                <head><title>An√°lisis de Orina</title></head>
                <body>
                    <h1>Laboratorio Esperanza</h1>
                    <h2>An√°lisis de Orina</h2>
                    <div>
                        <p><strong>Paciente:</strong> Ana Patricia Rodr√≠guez</p>
                        <p><strong>Orden:</strong> 007</p>
                        <p><strong>Doctor:</strong> Dr. L√≥pez</p>
                        <p><strong>Fecha:</strong> {}</p>
                    </div>
                    <div>
                        <h3>Resultados:</h3>
                        <ul>
                            <li>Densidad: 1.020</li>
                            <li>pH: 6.5</li>
                            <li>Prote√≠nas: Negativo</li>
                        </ul>
                    </div>
                </body>
                </html>
                """.format(datetime.now().strftime("%d/%m/%Y")),
                "metadata": {
                    "patient_name": "Ana Patricia Rodr√≠guez",
                    "order_number": "007",
                    "doctor_name": "Dr. L√≥pez",
                    "notes": "An√°lisis de orina - Prueba frontend"
                }
            }
        ]
        
        # Subir archivos simulando el frontend
        uploaded_files = []
        for i, file_data in enumerate(test_files, 1):
            print(f"\nüì§ Subiendo archivo {i}/3...")
            
            # Crear estructura de directorios
            directory_path = service.create_directory_structure()
            
            # Generar nombre de archivo
            filename = service.generate_file_name(f"reporte_{i}.html", "frontend")
            
            # Ruta completa del archivo
            file_path = os.path.join(directory_path, filename)
            
            # Preparar metadatos
            metadata = file_data["metadata"].copy()
            metadata.update({
                "uploaded_at": datetime.now().isoformat(),
                "source": "frontend_simulation",
                "original_filename": f"reporte_{i}.html",
                "status": "pending"  # Estado por defecto
            })
            
            # Guardar archivo
            service.save_html_file(file_data["html_content"], file_path, metadata)
            
            file_info = {
                "filename": filename,
                "file_path": file_path,
                "metadata": metadata
            }
            uploaded_files.append(file_info)
            
            print(f"‚úÖ Archivo {i} subido: {filename}")
            print(f"   üë§ Paciente: {metadata['patient_name']}")
            print(f"   üìã Orden: {metadata['order_number']}")
            print(f"   üë®‚Äç‚öïÔ∏è Doctor: {metadata['doctor_name']}")
            print(f"   ‚è≥ Estado: {metadata['status']}")
        
        print(f"\n‚úÖ Total de archivos subidos: {len(uploaded_files)}")
        
        # 2. SIMULAR OBTENER ARCHIVOS PENDIENTES (LO QUE VER√çA EL FRONTEND)
        print("\nüìã 2. SIMULANDO OBTENER ARCHIVOS PENDIENTES (FRONTEND)")
        print("-" * 50)
        
        # Obtener archivos pendientes
        pending_files = service.get_pending_files(limit=10)
        print(f"üìä Archivos pendientes encontrados: {len(pending_files)}")
        
        if pending_files:
            print("\nüìã Lista de archivos pendientes (ordenados por fecha de creaci√≥n):")
            for i, file_info in enumerate(pending_files, 1):
                metadata = file_info.get('metadata', {})
                print(f"\n  {i}. üìÑ {file_info['filename']}")
                print(f"     üë§ Paciente: {metadata.get('patient_name', 'N/A')}")
                print(f"     üìã Orden: {metadata.get('order_number', 'N/A')}")
                print(f"     üë®‚Äç‚öïÔ∏è Doctor: {metadata.get('doctor_name', 'N/A')}")
                print(f"     üìÖ Creado: {metadata.get('created_at', file_info.get('created_at', 'N/A'))}")
                print(f"     ‚è≥ Estado: {metadata.get('status', 'unknown')}")
                print(f"     üìè Tama√±o: {file_info.get('size', 0)} bytes")
        else:
            print("‚ùå No se encontraron archivos pendientes")
        
        # 3. SIMULAR PROCESAR ARCHIVOS (CAMBIAR ESTADO)
        print("\nüîÑ 3. SIMULANDO PROCESAR ARCHIVOS (CAMBIAR ESTADO)")
        print("-" * 50)
        
        if pending_files:
            # Procesar el primer archivo (marcar como completado)
            first_file = pending_files[0]
            print(f"‚úÖ Procesando archivo: {first_file['filename']}")
            
            # Cambiar estado a completado
            service.update_file_status(first_file['file_path'], 'completed')
            print(f"‚úÖ Estado cambiado a: completed")
            
            # Verificar cambio
            updated_metadata = service.get_file_metadata(first_file['file_path'])
            if updated_metadata:
                print(f"üìä Estado actualizado: {updated_metadata.get('status', 'unknown')}")
                print(f"üìÖ Fecha de finalizaci√≥n: {updated_metadata.get('completed_at', 'N/A')}")
        
        # 4. SIMULAR OBTENER ARCHIVOS COMPLETADOS
        print("\n‚úÖ 4. SIMULANDO OBTENER ARCHIVOS COMPLETADOS")
        print("-" * 50)
        
        completed_files = service.get_completed_files(limit=10)
        print(f"üìä Archivos completados encontrados: {len(completed_files)}")
        
        if completed_files:
            print("\n‚úÖ Lista de archivos completados:")
            for i, file_info in enumerate(completed_files, 1):
                metadata = file_info.get('metadata', {})
                print(f"\n  {i}. üìÑ {file_info['filename']}")
                print(f"     üë§ Paciente: {metadata.get('patient_name', 'N/A')}")
                print(f"     üìã Orden: {metadata.get('order_number', 'N/A')}")
                print(f"     üë®‚Äç‚öïÔ∏è Doctor: {metadata.get('doctor_name', 'N/A')}")
                print(f"     ‚úÖ Completado: {metadata.get('completed_at', 'N/A')}")
                print(f"     üìÖ Creado: {metadata.get('created_at', 'N/A')}")
        else:
            print("‚ùå No se encontraron archivos completados")
        
        # 5. SIMULAR OBTENER ESTAD√çSTICAS
        print("\nüìä 5. SIMULANDO OBTENER ESTAD√çSTICAS")
        print("-" * 50)
        
        stats = service.get_status_stats()
        print("üìä Estad√≠sticas del sistema:")
        print(f"  üìÑ Total de archivos: {stats['total_files']}")
        print(f"  ‚è≥ Pendientes: {stats['pending_count']}")
        print(f"  ‚úÖ Completados: {stats['completed_count']}")
        print(f"  ‚ùå Cancelados: {stats['cancelled_count']}")
        
        print("\nüìä Distribuci√≥n por estado:")
        for status, count in stats['by_status'].items():
            print(f"  {status}: {count} archivos")
        
        # 6. SIMULAR B√öSQUEDA POR ESTADO
        print("\nüîç 6. SIMULANDO B√öSQUEDA POR ESTADO")
        print("-" * 50)
        
        for status in ['pending', 'completed', 'cancelled']:
            files_by_status = service.get_files_by_status(status, limit=10)
            print(f"üìä Archivos con estado '{status}': {len(files_by_status)}")
            
            if files_by_status:
                for file_info in files_by_status:
                    metadata = file_info.get('metadata', {})
                    print(f"  üìÑ {file_info['filename']} - {metadata.get('patient_name', 'N/A')}")
        
        # 7. SIMULAR OBTENER TODOS LOS ARCHIVOS (HISTORIAL)
        print("\nüìö 7. SIMULANDO OBTENER HISTORIAL COMPLETO")
        print("-" * 50)
        
        all_files = service.list_html_files(limit=20)
        print(f"üìä Total de archivos en el sistema: {len(all_files)}")
        
        if all_files:
            print("\nüìö Historial completo (todos los archivos):")
            for i, file_info in enumerate(all_files, 1):
                metadata = file_info.get('metadata', {})
                status = metadata.get('status', 'unknown')
                status_icon = "‚è≥" if status == "pending" else "‚úÖ" if status == "completed" else "‚ùå"
                
                print(f"\n  {i}. {status_icon} {file_info['filename']}")
                print(f"     üë§ Paciente: {metadata.get('patient_name', 'N/A')}")
                print(f"     üìã Orden: {metadata.get('order_number', 'N/A')}")
                print(f"     üë®‚Äç‚öïÔ∏è Doctor: {metadata.get('doctor_name', 'N/A')}")
                print(f"     üìä Estado: {status}")
                print(f"     üìÖ Creado: {metadata.get('created_at', file_info.get('created_at', 'N/A'))}")
                if status == "completed":
                    print(f"     ‚úÖ Completado: {metadata.get('completed_at', 'N/A')}")
        
        print("\nüéâ ¬°Simulaci√≥n del frontend completada exitosamente!")
        
        # Mostrar resumen final
        print("\nüìä Resumen de la simulaci√≥n:")
        print(f"  üìÅ Directorio base: {service.html_base_path}")
        print(f"  üìÑ Archivos creados: {len(uploaded_files)}")
        print(f"  ‚è≥ Pendientes: {stats['pending_count']}")
        print(f"  ‚úÖ Completados: {stats['completed_count']}")
        print(f"  üìÖ Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        
        return True
        
    except Exception as e:
        print(f"\n‚ùå Error durante la simulaci√≥n del frontend: {str(e)}")
        import traceback
        traceback.print_exc()
        return False

def test_api_endpoints_simulation():
    """Simular llamadas a los endpoints de la API"""
    
    print("\nüåê Simulando llamadas a endpoints de la API...")
    print("=" * 60)
    
    # Simular endpoints que el frontend usar√≠a
    endpoints_to_test = [
        {
            "method": "GET",
            "endpoint": "/api/frontend-html/pending",
            "description": "Obtener archivos pendientes",
            "params": {"limit": 20}
        },
        {
            "method": "GET", 
            "endpoint": "/api/frontend-html/completed",
            "description": "Obtener archivos completados",
            "params": {"limit": 20}
        },
        {
            "method": "GET",
            "endpoint": "/api/frontend-html/status-stats",
            "description": "Obtener estad√≠sticas por estado",
            "params": {}
        },
        {
            "method": "GET",
            "endpoint": "/api/frontend-html/list",
            "description": "Listar todos los archivos",
            "params": {"limit": 50}
        },
        {
            "method": "PATCH",
            "endpoint": "/api/frontend-html/file/<filename>/status",
            "description": "Actualizar estado de archivo",
            "params": {"status": "completed"}
        }
    ]
    
    print("üì° Endpoints que el frontend usar√≠a:")
    for i, endpoint in enumerate(endpoints_to_test, 1):
        print(f"\n  {i}. {endpoint['method']} {endpoint['endpoint']}")
        print(f"     üìù {endpoint['description']}")
        if endpoint['params']:
            print(f"     üìä Par√°metros: {endpoint['params']}")
    
    print("\n‚úÖ Simulaci√≥n de endpoints completada")
    return True

def main():
    """Funci√≥n principal de simulaci√≥n"""
    
    print("üöÄ Iniciando simulaci√≥n completa del frontend")
    print("=" * 70)
    
    # Simular flujo de trabajo del frontend
    workflow_success = simulate_frontend_workflow()
    
    # Simular endpoints de API
    api_success = test_api_endpoints_simulation()
    
    print("\n" + "=" * 70)
    print("üìä Resultados de la simulaci√≥n del frontend:")
    print(f"  üîß Flujo de trabajo: {'‚úÖ Exitoso' if workflow_success else '‚ùå Fall√≥'}")
    print(f"  üåê Endpoints API: {'‚úÖ Exitoso' if api_success else '‚ùå Fall√≥'}")
    
    if workflow_success and api_success:
        print("\nüéâ ¬°Simulaci√≥n del frontend completada exitosamente!")
        print("‚ú® El sistema est√° listo para mostrar archivos en el frontend")
        print("\nüìã Funcionalidades verificadas:")
        print("  ‚úÖ Subida de archivos HTML")
        print("  ‚úÖ Estado autom√°tico 'pending'")
        print("  ‚úÖ Obtenci√≥n de archivos pendientes")
        print("  ‚úÖ Cambio de estados")
        print("  ‚úÖ Filtrado por estado")
        print("  ‚úÖ Estad√≠sticas por estado")
        print("  ‚úÖ Historial completo")
        print("  ‚úÖ Ordenamiento por fecha")
        return 0
    else:
        print("\n‚ùå Algunas simulaciones fallaron")
        return 1

if __name__ == "__main__":
    exit_code = main()
    sys.exit(exit_code)
